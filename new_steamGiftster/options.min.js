var DEV=(localStorage.dev==="true")?true:false;var existing=null;var dlc=null;var priorities=null;function bullcrap(b,c){var a=localStorage[b];if(!a){localStorage[b]=c;a=c}return a}function load_games(){existing=localStorage.existing;dlc=localStorage.dlc;priorities=localStorage.priorities;if(existing){existing=existing.split("<!$!>")}else{existing=[]}if(dlc){dlc=dlc.split("<!$!>")}else{dlc=[]}if(priorities){priorities=priorities.split("<!$!>")}else{priorities=[]}Log(existing);Log(dlc);Log(priorities);var b=[];for(var e=0;e<priorities.length;e+=2){var l={title:priorities[e],priority:priorities[e+1]};l.existing=existing.indexOf(l.title)!==-1;l.dlc=dlc.indexOf(l.title)!==-1;b.push(l)}b=b.sort(function(i,c){if((i.existing)&&!(c.existing)){return 1}else{if((c.existing)&&!(i.existing)){return -1}}if(i.priority!=c.priority){return c.priority-i.priority}return i.title.localeCompare(c.title)});for(var e=0;e<b.length;++e){var h=e%2==0?"":"alt";var j="<div class='tr'><span class='th spec"+h+"'><span class='name'>"+b[e].title+"</span></span><span class='td td-first "+h+"'><input type='number' class='priority gameinput' name='priority' value='"+b[e].priority+"'></span><span class='td "+h+"'><input type='checkbox' class='owned gameinput' name='owned' "+(b[e].existing?"checked":"")+"></span><span class='td "+h+"'><input type='checkbox' class='dlc gameinput' name='dlc' "+(b[e].dlc?"checked":"")+"></span></div>";$("#games").append(j)}var a=$("#dev");$("#page_seconds_min").val(bullcrap("page_seconds_min",4));$("#page_seconds_max").val(bullcrap("page_seconds_max",10));$("#contest_seconds_min").val(bullcrap("contest_seconds_min",2));$("#contest_seconds_max").val(bullcrap("contest_seconds_max",3));$("#forum_seconds_min").val(bullcrap("forum_seconds_min",4));$("#forum_seconds_max").val(bullcrap("forum_seconds_max",10));$("#exec_minutes_min").val(bullcrap("exec_minutes_min",35));$("#exec_minutes_max").val(bullcrap("exec_minutes_max",60));$("#sleep_begin").val(bullcrap("sleep_begin","00:01"));$("#sleep_end").val(bullcrap("sleep_end","00:02"));$("#forum_post_age").val(bullcrap("forum_post_age",1));$ch=(bullcrap("dev",DEV)==="true")?true:false;a.prop("checked",$ch);$(".timeinput").change(function(){UpdateTime($(this))});var g=$("#priorities");var f=$("#existing");var k=$("#dlcs");var d=$("#skip_posts");g.val(localStorage.priorities);f.val(localStorage.existing);k.val(localStorage.dlc);d.val(bullcrap("skip_posts","http://www.steamgifts.com/forum/5vgHq/faq-site-guidelines-comment-formatting-user-add-ons"));d.change(function(){localStorage.skip_posts=$(this).val()});g.change(function(){localStorage.priorities=$(this).val()});f.change(function(){localStorage.existing=$(this).val()});k.change(function(){localStorage.dlc=$(this).val()});a.change(function(){localStorage.dev=$(this).is(":checked")});$(".gameinput").change(function(){var r=$(this).parent().parent();var i=r.find("span.name").text();var o=r.find("input.priority").val();var p=r.find("input.owned").is(":checked");var q=r.find("input.dlc").is(":checked");Log(i+" "+o+" "+p+" "+q);var c=existing.indexOf(i);var n=dlc.indexOf(i);var m=priorities.indexOf(i);priorities[m+1]=o;if(p&&c===-1){existing.push(i)}else{if(!p&&c!==-1){existing.splice(c,1)}}if(q&&n===-1){dlc.push(i)}else{if(!q&&n!==-1){dlc.splice(n,1)}}localStorage.priorities=priorities.join("<!$!>");localStorage.existing=existing.join("<!$!>");localStorage.dlc=dlc.join("<!$!>")});$(".clearurlstrings").click(function(){localStorage.urlStrings=""});$(".cleardlc").click(function(){localStorage.dlc="";location.reload()});$(".clear_id").click(function(){chrome.storage.sync.get("user_id",function(c){DEV&&console.log(c)});chrome.storage.sync.remove("user_id")});$(".storage_download").click(function(){loadChangesAjax()});$(".storage_upload").click(function(){DEV&&console.log("storage clicked");chrome.storage.sync.get("user_id",function(c){if(JSON.stringify(c)=="{}"){DEV&&console.log("empty")}else{localStorage.user_id=c.user_id}setTimeout(saveChangesAjax(),500)})});$("#usedChars").text(GetLocalStorageUsed());$("#usedPercent").text(100*(GetLocalStorageUsed()/(2.5*1024*1024)))}function saveChangesAjax(){var a=$.ajax({method:"POST",url:"http://worldcup-vrobik.rhcloud.com/sync-set",data:{id:localStorage.user_id,existing:localStorage.existing,urlstrings:localStorage.urlStrings,priorities:localStorage.priorities,dlc:localStorage.dlc}});a.done(function(b){localStorage.user_id=b;setTimeout(saveChanges(),1000);DEV&&console.log("Done id:"+b)});a.fail(function(b,c){DEV&&console.log(b);DEV&&console.log("Request failed: "+c)})}function loadChangesAjax(){var a=$.ajax({method:"POST",url:"http://worldcup-vrobik.rhcloud.com/sync-get",data:{id:localStorage.user_id}});a.done(function(b){b=JSON.parse(b);localStorage.existing=b.existing;localStorage.urlStrings=b.urlstrings;localStorage.priorities=b.priorities;localStorage.dlc=b.dlc});a.fail(function(b,c){DEV&&console.log(b);DEV&&console.log("Request failed: "+c)})}function saveChanges(){var a=localStorage.user_id;if(!a){DEV&&console.log("Error: No value specified");return}chrome.storage.sync.set({user_id:a},function(){DEV&&console.log("Settings saved")})}function UpdatePriority(b){var a=$(b).parent().parent().find(".th").first().find("span").text();alert(a)}function UpdateOwned(b){var a=$(b).parent().parent().find(".th").first().find("span").text();alert(a)}function UpdateDLC(b){var a=$(b).parent().parent().find(".th").first().find("span").text();alert(a)}function UpdateTime(a){localStorage[$(a).attr("id")]=$(a).val();Log(localStorage[$(a).attr("id")])}function GetLocalStorageUsed(){charsUsed=0;for(var a in localStorage){charsUsed=charsUsed+(2*a.length)+(localStorage[a].length*2)}return charsUsed}function Log(a){if(typeof a=="string"){DEV&&console.log(new Date().toTimeString()+" "+a)}else{DEV&&console.log(new Date().toTimeString());DEV&&console.log(a)}}document.addEventListener("DOMContentLoaded",load_games);