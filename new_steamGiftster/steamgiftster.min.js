var DEV=(localStorage.dev==="true")?true:false;var lastRequest=null;chrome.runtime.onMessage.addListener(function(c,b,a){Log(c);Log(b);lastRequest=c;if($("img.nav__sits").length>0){alert("Please login!");$("img.nav__sits").click()}else{if($(".nav__button-container--active .nav__notification").length>0){chrome.runtime.sendMessage({type:"won_game"});setTimeout(alert("WOOOOOON"),50000)}else{if(c.type=="scrape_open"){Scrape()}else{if(c.type=="enter_contest"){EnterContest()}else{if(c.type=="remove_contest"){RemoveContest()}else{if(c.type=="scrape_threads"){ScrapeThreads()}else{if(c.type=="scrape_posts"){ScrapePosts()}}}}}}}});function GetNumeric(a){return a.replace(/\D/g,"")}function GetNumerics(c){var b=c.split(" ");for(var a=0;a<b.length;++a){b[a]=b[a].replace(/\D/g,"")}b=b.filter(function(d){return d});return b}function GetPoints(){var a=GetNumeric($(".nav__points").text());return parseInt(a)}function GetResults(){var a=$(".pagination__results").first().text();var b=GetNumerics(a);return{type:"number_of_contests",first:b[0],last:b[1],total:b[2]}}function GetContests(){var b=$("div.giveaway__row-outer-wrap").not(":has(div.contributor_only)");var a=$("div.giveaway__row-outer-wrap").has("div.giveaway__column--group");var d=$("div.giveaway__row-outer-wrap").has("div.giveaway__column--contributor-level.giveaway__column--contributor-level--positive");var c=$.merge(b,d,a);return c}function OpenContest(a){var b=a.find("a").first().attr("href");b="http://www.steamgifts.com"+b;chrome.runtime.sendMessage({type:"enter_contest",url:b})}function GetTimestamp(a){return Math.round(new Date().getTime()/1000)+a}function GetCloseTimestamp(a){var b=1;if(a.indexOf("minute")!==-1){b*=60}else{if(a.indexOf("hour")!==-1){b*=60*60}else{if(a.indexOf("day")!==-1){b*=60*60*24}else{if(a.indexOf("week")!==-1){b*=60*60*24*7}else{if(a.indexOf("month")!==-1){b*=60*60*24*30}}}}}if(a.indexOf("ago")!==-1){b*=-1}return GetTimestamp(GetNumeric(a)*b)}function Scrape(){var b={};b.results=GetResults();var d=GetContests();var e=[];for(var a=0;a<d.length;++a){var c={};c.url="http://www.steamgifts.com"+$(d[a]).find(".giveaway__heading__name").attr("href");c.title=$(d[a]).find(".giveaway__heading__name").text();c.entered=$(d[a]).find(".giveaway__row-inner-wrap").hasClass("is-faded");c.cost=parseInt(GetNumeric($(d[a]).find(".giveaway__heading__thin").last().text()));c.closes=GetCloseTimestamp($(d[a]).find(".giveaway__columns div span").first().text());c.source="public";e.push(c)}b.contests=e;chrome.runtime.sendMessage({type:"scrape_results",data:b,points:GetPoints()})}function EnterContest(){var b=$(".sidebar__entry-insert");var a=0;if(b.text().indexOf("Enter Giveaway")!==-1){Log("Entering!");a=1;b.click();chrome.runtime.sendMessage({type:"enter_result",succeeded:a,reason:b.text(),lastRequest:lastRequest,points:GetPoints()})}else{chrome.runtime.sendMessage({type:"enter_result",succeeded:a,reason:b.text(),lastRequest:lastRequest,points:GetPoints()})}}function RemoveContest(){var b=$(".sidebar__entry-delete");var a=0;if(b.text().indexOf("Remove Entry")!==-1){Log("Removing!");a=1;b.click();chrome.runtime.sendMessage({type:"remove_result",succeeded:a,reason:b.text(),lastRequest:lastRequest,points:GetPoints()})}else{chrome.runtime.sendMessage({type:"remove_result",succeeded:a,reason:b.text(),lastRequest:lastRequest,points:GetPoints()})}}function GetThreads(){return $(".row")}function ScrapeThreads(){var d=GetThreads();var c=[];for(var b=0;b<d.length;++b){var a={};a.url="http://www.steamgifts.com"+$(d[b]).find("div.details div.title a").attr("href");if($(d[b]).find("div.reply p")){a.lastPost=GetCloseTimestamp($(d[b]).find("div.reply p").first().text())}else{a.lastPost=GetCloseTimestamp($(d[b]).find("div.author p a").last().text())}c.push(a)}chrome.runtime.sendMessage({type:"forum_scrape_results",data:c,points:GetPoints()})}function ScrapePosts(){var d=$('a[href*="/giveaway/"]');var c=[];for(var b=0;b<d.length;++b){var a=$(d[b]).attr("href");if(a.indexOf("http://www.steamgifts.com")===-1){a="http://www.steamgifts.com"+a}c.push(a)}chrome.runtime.sendMessage({type:"scrape_posts_results",data:c,points:GetPoints(),results:GetResults(),url:lastRequest.url})}function Log(a){if(typeof a=="string"){DEV&&console.log(new Date().toTimeString()+" "+a)}else{DEV&&console.log(new Date().toTimeString());DEV&&console.log(a)}};