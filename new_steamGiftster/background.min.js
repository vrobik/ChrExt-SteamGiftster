var DEV=(localStorage.dev==="true")?true:false;var idsToActions={};var contests=[];var page=1;var tabIds=[];var existing=[];var dlc=[];var priorities=[];var urlStrings=[];var blackFont=new Image();var whiteFont=new Image();var actionQueue=[];var maxQueueSize=0;blackFont.src="font_black.png";whiteFont.src="font_white.png";var refreshInterval=null;var wId=null;var iconCanvas=document.createElement("canvas");iconCanvas.setAttribute("width",19);iconCanvas.setAttribute("height",19);var iconContext=iconCanvas.getContext("2d");var iconImage=new Image();iconImage.src="icon.png";var iconCanvasWon=document.createElement("canvas");iconCanvasWon.setAttribute("width",19);iconCanvasWon.setAttribute("height",19);var iconContextWon=iconCanvasWon.getContext("2d");var iconImageWon=new Image();iconImageWon.src="gift.png";var running=false;var points=0;var retryCount=0;var tabUrls={};var starfield=[];var starfieldCenter={x:9.5,y:6};var nextThingToDo=null;var timeUntilNextThing=0;var nextThingTimeout=null;var forumThreads=[];var forumPage=1;var contestUrls=[];var postsPage=1;chrome.browserAction.onClicked.addListener(function(){if(!running){iconContext.clearRect(0,0,19,19);InitializeStarfield();UpdateProgressBar(0,10);UpdateCountdown(0);UpdateEntered();UpdatePoints();UpdateIconDisplay();running=true;maxQueueSize=0;Scrape()}else{StopRunning()}});chrome.tabs.onUpdated.addListener(function(a,b){if(b.hasOwnProperty("url")){tabUrls[a]=b.url}else{if(!tabUrls.hasOwnProperty(a)){tabUrls[a]="www.steamgifts.com"}}if(b.status=="complete"){if(idsToActions.hasOwnProperty(a)){chrome.tabs.sendMessage(a,idsToActions[a])}else{}}});chrome.windows.onRemoved.addListener(function(a){if(a==wId){StopRunning();wId=null}});chrome.tabs.onRemoved.addListener(function(a,c){var b=tabIds.indexOf(a);if(b!==-1){tabIds.splice(b,1)}if(idsToActions.hasOwnProperty(a)){delete idsToActions[a]}});chrome.runtime.onMessage.addListener(MessageHandler);function StopRunning(){iconContext.clearRect(0,0,19,19);RevertIcon();UpdateIconDisplay();clearTimeout(nextThingTimeout);ClearAnInterval("Terminating",refreshInterval);for(var a=0;a<tabIds.length;++a){chrome.tabs.remove(tabIds[a])}running=false}function RevertIcon(){iconContext.drawImage(iconImage,0,0,19,19)}function GetTimestamp(a){return Math.round(new Date().getTime()/1000)+a}function bullcrap(b,c){var a=localStorage[b];if(!a){localStorage[b]=c;a=c}return a}function IsAsleep(){var b=bullcrap("sleep_begin","00:01");var a=bullcrap("sleep_end","00:02");b=parseInt(b.replace(":",""));a=parseInt(a.replace(":",""));var f=new Date();var c=(f.getHours()*100)+f.getMinutes();var e=false;if(b<a){e=c>=b&&c<a}else{e=c>=b||c<a}return e}function GetMillisecondsUntilWakeup(){var h=new Date();var g=parseInt((h.getHours()*100)+h.getMinutes());var c=bullcrap("sleep_end","18:00");var f=c.split(":");var b=0;if(parseInt(c.replace(":",""))>g){var e=parseInt(f[0])-h.getHours();var a=parseInt(f[1])-h.getMinutes();b=(e*1000*60*60)+(a*1000*60)}else{var e=(24-h.getHours())+parseInt(f[0]);var a=parseInt(f[1])-h.getMinutes();b=(e*1000*60*60)+(a*1000*60)}return b}function InitializeStarfield(){starfield=[];for(var c=0;c<20;++c){var a=Math.random()*19;var g=Math.random()*14;var e=Math.sqrt(Math.pow(a-starfieldCenter.x,2)+Math.pow(g-starfieldCenter.y,2));var f=((a-starfieldCenter.x)/e)/(Math.random()*5+5);var b=((g-starfieldCenter.y)/e)/(Math.random()*5+5);starfield.push({x:a,y:g,xv:f,yv:b,b:0})}}function DrawStarfield(){iconContext.fillStyle="#000000";iconContext.fillRect(0,0,19,19);for(var a=0;a<starfield.length;++a){iconContext.fillStyle="rgba("+starfield[a].b+","+starfield[a].b+","+starfield[a].b+",255)";iconContext.fillRect(starfield[a].x-starfield[a].s/2,starfield[a].y-starfield[a].s/2,starfield[a].s,starfield[a].s)}}function UpdateStarfield(){for(var c=0;c<starfield.length;++c){var e=starfield[c].x-starfieldCenter.x;var f=starfield[c].y-starfieldCenter.y;var g=Math.sqrt((e*e)+(f*f));starfield[c].x=starfield[c].x+((g+0.1)*starfield[c].xv);starfield[c].y=starfield[c].y+((g+0.1)*starfield[c].yv);if(starfield[c].x<-1||starfield[c].x>20||starfield[c].y<-1||starfield[c].y>20){starfield[c].x=starfieldCenter.x;starfield[c].y=starfieldCenter.y;var b=Math.random()*2*Math.PI;starfield[c].xv=Math.sin(b)/(Math.random()*5+5);starfield[c].yv=Math.cos(b)/(Math.random()*5+5);starfield[c].b=0}else{var h=g/13.435;starfield[c].b=Math.floor(h*256)*2}starfield[c].s=(starfield[c].b/256)*2;starfield[c].b=255}}function UpdatePoints(){iconContext.fillStyle="#FFFFFF";iconContext.fillRect(0,4,19,8);var e=GetTimestamp(0);var b=contests.slice(0);var d=0;for(var a=0;a<b.length;++a){if(b[a].closes>e&&b[a].entered){d+=b[a].cost}}var c=d.toString();DrawNumber(19-(c.length*3),5,blackFont,d)}function UpdateActivity(){var h=GetTimestamp(0);var e=[];var f=[];var d=contests.slice(0);for(var c=0;c<19;++c){e[c]=0;f[c]=0}d.sort(function(j,i){return i.closes-j.closes});for(var c=0;c<d.length;++c){if(d[c].closes>h){var b=Math.floor((d[c].closes-h)/(60*60));if(isNaN(b)){Log(d[c].closes);Log(h)}if(b<19){if(d[c].entered){e[b]++}f[b]++}}}iconContext.fillStyle="#000000";iconContext.fillRect(0,4,19,8);var a=e[0];var g=f[0];for(var c=1;c<19;++c){a=Math.max(a,e[c]);g=Math.max(g,f[c])}if(g==0){return}iconContext.lineWidth=1;iconContext.lineCap="butt";for(var c=0;c<19;++c){if(f[c]>0){iconContext.strokeStyle=c%2==0?"rgba(0,0,255,255)":"rgba(0,0,128,255)";iconContext.beginPath();iconContext.moveTo(c+0.5,11.5);iconContext.lineTo(c+0.5,11.5-Math.floor((f[c]/g)*8));iconContext.stroke()}if(e[c]>0){iconContext.strokeStyle=c%2==0?"rgba(0,128,0,128)":"rgba(0,255,0,128)";iconContext.beginPath();iconContext.moveTo(c+0.5,11.5);iconContext.lineTo(c+0.5,11.5-Math.floor((e[c]/a)*8));iconContext.stroke()}}}function UpdateEntered(){var d=GetTimestamp(0);iconContext.fillStyle="#808080";iconContext.fillRect(0,12,10,7);iconContext.fillStyle="#000000";iconContext.fillRect(0,13,9,6);var b=0;for(var a=0;a<contests.length;++a){if(contests[a].entered&&contests[a].closes>d){b++}}var c=b.toString();DrawNumber(10-(c.length*3),12,whiteFont,b)}function UpdateIconDisplay(){var a=iconContext.getImageData(0,0,19,19);chrome.browserAction.setIcon({imageData:a})}function UpdateProgressBar(b,c){var a=b/c;iconContext.fillStyle="#000000";iconContext.fillRect(0,0,19,4);iconContext.fillStyle="#008000";iconContext.fillRect(1,1,a*17,2);iconContext.fillStyle="#00FF00";iconContext.fillRect(1,2,a*17,1)}function UpdateCountdown(b){iconContext.fillStyle="#808080";iconContext.fillRect(9,12,10,7);iconContext.fillStyle="#FFFFFF";iconContext.fillRect(10,13,9,8);var a=b.toString();DrawNumber(19-(a.length*3),12,blackFont,b)}function DrawNumber(a,g,b,f){var e=f.toString();for(var d=0;d<e.length;++d){var c=parseInt(e[d]);iconContext.drawImage(b,3*c,0,3,7,a+(3*d),g,3,7)}}function Scrape(){if(!wId){chrome.windows.create({url:chrome.extension.getURL("about.html")},function(a){wId=a.id})}tabIds=[];existing=localStorage.existing;dlc=localStorage.dlc;priorities=localStorage.priorities;urlStrings=localStorage.urlStrings;if(existing){existing=existing.split("<!$!>")}else{existing=[]}if(dlc){dlc=dlc.split("<!$!>")}else{dlc=[]}if(priorities){priorities=priorities.split("<!$!>")}else{priorities=[]}if(urlStrings){urlStrings=urlStrings.split("<!$!>")}else{urlStrings=[]}page=1;forumPage=1;actionQueue=[];actionQueue.push({action:"scrape_open"});actionQueue.push({action:"enter_contests"});ProcessActionQueue()}function DelayAndThenDoThing(a,b){timeUntilNextThing=Math.floor(a+(Math.random()*(b-a)));if(timeUntilNextThing<1000*60){UpdateCountdown(Math.floor(timeUntilNextThing/1000));UpdateIconDisplay();nextThingTimeout=setTimeout(CheckDelayAndDoThing,1000)}else{UpdateCountdown(Math.floor(timeUntilNextThing/(60*1000)));UpdateIconDisplay();nextThingTimeout=setTimeout(CheckDelayAndDoThing,1000*60)}}function CheckDelayAndDoThing(){var b=IsAsleep();if(b){ClearAnInterval("Going to sleep",refreshInterval);nextThingToDo=Scrape;for(var a=0;a<tabIds.length;++a){chrome.tabs.remove(tabIds[a])}tabIds=[];UpdateStarfield();DrawStarfield();timeUntilNextThing=GetMillisecondsUntilWakeup()}if(timeUntilNextThing<1000*60){if(!b){timeUntilNextThing-=1000}UpdateCountdown(Math.floor(timeUntilNextThing/1000));UpdateIconDisplay()}else{if(!b){timeUntilNextThing-=(1000*60)}UpdateCountdown(Math.floor(timeUntilNextThing/(1000*60)));UpdateIconDisplay()}if(Math.floor(timeUntilNextThing/1000)<=0){UpdateCountdown(0);UpdateIconDisplay();nextThingToDo()}else{if(timeUntilNextThing<1000*60){nextThingTimeout=setTimeout(CheckDelayAndDoThing,1000)}else{nextThingTimeout=setTimeout(CheckDelayAndDoThing,1000*60)}}}function MessageHandler(e,g,a){Log(e);Log(g);if(!running){return}delete idsToActions[g.tab.id];if(e.type=="won_game"){iconContext.clearRect(0,0,19,19);iconContext.drawImage(iconImageWon,0,0,19,19);var k=iconContext.getImageData(0,0,19,19);chrome.browserAction.setIcon({imageData:k})}else{if(e.type=="scrape_posts_results"){HandleScrapedPosts(e,g)}else{if(e.type=="forum_scrape_results"){ScrapeForumThreads(e,g)}else{if(e.type=="scrape_results"){UpdateProgressBar(e.data.results.last,e.data.results.total);UpdateIconDisplay();ClearAnInterval("Got message with scrape results",refreshInterval);contests=contests.concat(e.data.contests);contests=contests.filter(function(p,o,m){for(var n=o+1;n<m.length;++n){if(m[n].url===p.url){return false}}return true});UpdateEntered();UpdatePoints();UpdateIconDisplay();if(e.data.results.last!=e.data.results.total){nextThingToDo=function(){++page;chrome.tabs.update(g.tab.id,{url:"http://www.steamgifts.com/giveaways/search?page="+page});idsToActions[g.tab.id]={type:"scrape_open"};ReloadUntilResult(g.tab.id)};DelayAndThenDoThing(bullcrap("page_seconds_min",4)*1000,bullcrap("page_seconds_max",10)*1000)}else{for(var h=0;h<contests.length;++h){var l=priorities.indexOf(contests[h].title);var b=0;for(var f=0;f<contests.length;++f){if(contests[h].title==contests[f].title&&contests[f].entered){b++}}if(l===-1){priorities.push(contests[h].title);priorities.push(b);contests[h].priority=b}else{contests[h].priority=priorities[l+1]}var c=urlStrings.indexOf(contests[h].title);if(c===-1){urlStrings.push(contests[h].title);var d=contests[h].url.substring(contests[h].url.lastIndexOf("/")+1);urlStrings.push(d)}}localStorage.priorities=priorities.join("<!$!>");localStorage.urlStrings=urlStrings.join("<!$!>");points=e.points;ProcessActionQueue()}}else{if(e.type=="enter_result"){ClearAnInterval("got enter result",refreshInterval);setTimeout(function(){chrome.tabs.remove(g.tab.id);delete idsToActions[g.tab.id]},1000);if(e.succeeded!==1){if(e.lastRequest.title!="Unknown"){if(e.reason.indexOf("Exists")>-1||e.reason.indexOf("Missing")>-1){if(e.reason.indexOf("Exists")!==-1){if(existing.indexOf(e.lastRequest.title)===-1){existing.push(e.lastRequest.title);localStorage.existing=existing.join("<!$!>")}}if(e.reason.indexOf("Missing")!==-1){if(dlc.indexOf(e.lastRequest.title)===-1){dlc.push(e.lastRequest.title);localStorage.dlc=dlc.join("<!$!>")}}}}points=e.points}else{for(var h=0;h<contests.length;++h){if(contests[h].url==e.lastRequest.url){contests[h].entered=true}}points=e.points-e.lastRequest.cost}ProcessActionQueue()}else{if(e.type=="remove_result"){ClearAnInterval("got remove result",refreshInterval);setTimeout(function(){chrome.tabs.remove(g.tab.id);delete idsToActions[g.tab.id]},1000);if(e.succeeded!==1){points=e.points;contests=contests.filter(function(n,m,j){return n.url!==e.lastRequest.url})}else{for(var h=0;h<contests.length;++h){if(contests[h].url==e.lastRequest.url){contests[h].entered=false}}points=e.points+e.lastRequest.cost}ProcessActionQueue()}}}}}}}function EnterContest(a){nextThingToDo=function(){chrome.tabs.create({windowId:wId,url:a.url,index:9999,active:false},function(b){idsToActions[b.id]={type:"enter_contest",title:a.title,cost:a.cost};tabIds.push(b.id);ReloadUntilResult(b.id)})};DelayAndThenDoThing(bullcrap("contest_seconds_min",2)*1000,bullcrap("contest_seconds_max",3)*1000)}function RemoveContest(a){nextThingToDo=function(){chrome.tabs.create({windowId:wId,url:a.url,index:9999,active:false},function(b){idsToActions[b.id]={type:"remove_contest",title:a.title,cost:a.cost,url:a.url};tabIds.push(b.id);ReloadUntilResult(b.id)})};DelayAndThenDoThing(bullcrap("contest_seconds_min",2)*1000,bullcrap("contest_seconds_max",3)*1000)}function ProcessActionQueue(){var a=false;while(actionQueue.length>0&&!a){maxQueueSize=Math.max(maxQueueSize,actionQueue.length);var c=actionQueue.shift();if(c.action=="enter"){if(!contests[c.index].entered&&dlc.indexOf(c.contest.title)===-1&&existing.indexOf(c.contest.title)===-1){if(c.contest.cost<=points){Log("Entering "+c.contest.title+" for "+c.contest.cost+" from "+c.contest.source+"("+c.contest.priority+")");EnterContest(c.contest);a=true}else{for(var e=contests.length-1;e>c.index;--e){if(contests[e].entered&&(contests[e].priority<c.contest.priority||contests[e].priority==0)){actionQueue.splice(0,0,c);actionQueue.splice(0,0,{contest:contests[e],index:e,action:"remove"});break}}}}}else{if(c.action=="remove"){Log("Removing "+c.contest.title+" for "+c.contest.cost+" from "+c.contest.source+"("+c.contest.priority+")");RemoveContest(c.contest);a=true}else{if(c.action=="scrape_posts"){ScrapePosts(c.url);a=true}else{if(c.action=="scrape_forums"){a=true;chrome.tabs.create({windowId:wId,url:"http://www.steamgifts.com/forum/page/1",index:9999,active:false},function(h){idsToActions[h.id]={type:"scrape_threads"};tabIds.push(h.id);ReloadUntilResult(h.id)})}else{if(c.action=="scrape_open"){a=true;chrome.tabs.create({windowId:wId,url:"http://www.steamgifts.com/giveaways/search?page=1",index:9999,active:false},function(h){idsToActions[h.id]={type:"scrape_open"};tabIds.push(h.id);ReloadUntilResult(h.id)})}else{if(c.action=="register_forum_contests"){contestUrls=contestUrls.filter(function(j){for(var h=0;h<contests.length;++h){if(contests[h].url.indexOf(j.url)!==-1){Log("Contest from forums is public!");return false}}return true});for(var e=0;e<contestUrls.length;++e){var f={};f.url=contestUrls[e];f.source="forum";var d=urlStrings.indexOf(f.url.substring(f.url.lastIndexOf("/")+1));if(d===-1){f.title="Unknown"}else{f.title=urlStrings[d-1]}f.cost=60;for(var b=0;b<contests.length;++b){if(contests[b].title==f.title){f.cost=contests[b].cost}}f.priority=1;var g=priorities.indexOf(f.title);if(g!==-1){f.priority=priorities[g+1]}f.priority++;f.closes=GetTimestamp(0);f.entered=false;if(f.priority!==0){contests.push(f)}}}else{if(c.action=="enter_contests"){contests=contests.filter(function(m,l,h){for(var k=l+1;k<h.length;++k){if(h[k].url===m.url){return false}}return m.url.indexOf("http://www.steamgifts.com/giveaway/")===0});contests.sort(function(i,h){if(i.priority!=h.priority){return h.priority-i.priority}if(i.priority!=0){return i.closes-h.closes}return h.closes-i.closes});for(var e=0;e<contests.length;++e){actionQueue.push({contest:contests[e],index:e,action:"enter"})}}}}}}}}}UpdateProgressBar(maxQueueSize-actionQueue.length,maxQueueSize);UpdateEntered();UpdatePoints();UpdateIconDisplay();if(!a&&actionQueue.length==0){UpdateEntered();UpdateIconDisplay();UpdateProgressBar(1,1);for(var e=0;e<tabIds.length;++e){chrome.tabs.remove(tabIds[e])}nextThingToDo=Scrape;DelayAndThenDoThing(bullcrap("exec_minutes_min",35)*1000*60,bullcrap("exec_minutes_max",60)*1000*60)}}function ScrapeForumThreads(e,c){ClearAnInterval("Got forum threads?",refreshInterval);var d=GetTimestamp(60*60*bullcrap("forum_post_age",1)*-1);var a=GetTimestamp(0);forumThreads=forumThreads.concat(e.data);forumThreads=forumThreads.filter(function(l,h,f){for(var g=h+1;g<f.length;++g){if(f[g].url===l.url){return false}}var k=bullcrap("skip_posts","http://www.steamgifts.com/forum/5vgHq/faq-site-guidelines-comment-formatting-user-add-ons").indexOf(l.url)===-1;if(!k){Log(l.url+" in skip list")}return k});for(var b=0;b<forumThreads.length;++b){a=Math.min(a,forumThreads[b].lastPost)}if(a>d){nextThingToDo=function(){++forumPage;chrome.tabs.update(c.tab.id,{url:"http://www.steamgifts.com/forum/page/"+forumPage});idsToActions[c.tab.id]={type:"scrape_threads"};ReloadUntilResult(c.tab.id)};DelayAndThenDoThing(bullcrap("page_seconds_min",4)*1000,bullcrap("page_seconds_max",10)*1000)}else{forumThreads=forumThreads.filter(function(f){return f.lastPost>=d});for(var b=0;b<forumThreads.length;++b){actionQueue.splice(0,0,{action:"scrape_posts",url:forumThreads[b].url})}ProcessActionQueue()}}function ScrapePosts(a){postsPage=1;nextThingToDo=function(){chrome.tabs.create({windowId:wId,url:a,index:9999,active:false},function(b){idsToActions[b.id]={type:"scrape_posts",url:a};tabIds.push(b.id);ReloadUntilResult(b.id)})};DelayAndThenDoThing(bullcrap("forum_seconds_min",4)*1000,bullcrap("forum_seconds_max",10)*1000)}function HandleScrapedPosts(b,a){ClearAnInterval("Got scraped posts?",refreshInterval);contestUrls=contestUrls.concat(b.data);if(b.results.last!=b.results.total){nextThingToDo=function(){++postsPage;chrome.tabs.update(a.tab.id,{url:b.url+"/page/"+postsPage});idsToActions[a.tab.id]={type:"scrape_posts",url:b.url};ReloadUntilResult(a.tab.id)};DelayAndThenDoThing(bullcrap("forum_seconds_min",4)*1000,bullcrap("forum_seconds_max",10)*1000)}else{setTimeout(function(){chrome.tabs.remove(a.tab.id);delete idsToActions[a.tab.id]},1000);ProcessActionQueue()}}function IfTabDoesNotExist(b,a){chrome.tabs.get(b,function(c){if(!c){a()}})}function HarshExit(){Log("Catastropic exit!  User meddling!  Unacceptable!");if(wId){chrome.windows.remove(wId)}wId=null;StopRunning()}function SetAnInterval(b,a){return setInterval(b,a)}function ClearAnInterval(b,a){clearInterval(a);a=null}function Reload(a){chrome.tabs.reload(a)}function ReloadUntilResult(a){retryCount=0;refreshInterval=SetAnInterval(function(){try{if(tabUrls.hasOwnProperty(a)&&tabUrls[a].indexOf("steamgifts.com")!==-1){Log("Reloading tab with url "+tabUrls[a]);Reload(a);++retryCount}IfTabDoesNotExist(a,HarshExit)}catch(b){ClearAnInterval(b,refreshInterval);throw b}},10000)}function Log(a){if(typeof a=="string"){DEV&&console.log(new Date().toTimeString()+" "+a)}else{DEV&&console.log(new Date().toTimeString());DEV&&console.log(a)}};